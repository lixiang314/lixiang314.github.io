<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
            <title>百度地图</title>
            <script type="text/javascript" src="http://api.map.baidu.com/api?v=1.3"></script>
            <script type="text/javascript" src="convertor.js"></script>
            <script src="https://cdn1.lncld.net/static/js/av-min-1.0.0.js"></script>
    </head>
    <body>
        
        
        <div style="width:800px;height:600px;border:1px solid gray" id="container"></div>
        <input type="text" name="" id="mytag" style="position:absolute; top:0;" placeholder="输入标签">
        <button id="tagok" style="position:absolute; top:20px;">确认</button>
        <button id="tagsave" style="position:absolute; top:40px;">储存</button>

        <script type="text/javascript">

        // 应用 ID，用来识别应用
        var APP_ID = '3YseRpKjpl4RJxOAOFLESCOK-gzGzoHsz';

        // 应用 Key，用来校验权限（Web 端可以配置安全域名来保护数据安全）
        var APP_KEY = 'WRmXQ12PGr7C47pA6DsX6NTO';

        // 初始化
        AV.init({
          appId: APP_ID,
          appKey: APP_KEY
        });

        var localtag = '';
        var longitude="";//经度
        var latitude="";//纬度
        var point = new BMap.Point(longitude, latitude);  // 创建点坐标

        //初始化地图
        var map = new BMap.Map("container");  // 创建地图实例
        map.addControl(new BMap.NavigationControl()); //添加平移缩放控件
        map.addControl(new BMap.ScaleControl());  //添加放大、缩小控件
        map.enableScrollWheelZoom();//允许鼠标滑轮操作
        var new_point = new BMap.Point(longitude,latitude);
        var markerid = '';

        var query = new AV.Query('MarkObject');
        query.find().then(function (results) {
          for (var i = 0; i < results.length; i++) {
              var mark = results[i];
              markerid = mark.get('id');
              console.log(markerid);
              query.get(markerid).then(function (data) {

                var name = data.get('name');
                longitude = data.get('longitude');
                latitude = data.get('latitude');
                console.log(name);
                console.log(longitude);
                console.log(latitude);

                var new_point = new BMap.Point(longitude,latitude);
                var marker = new BMap.Marker(new_point);  // 创建标注
                map.addOverlay(marker);              // 将标注添加到地图中
                var label = new BMap.Label(name,{offset:new BMap.Size(20,-10)});
                marker.setLabel(label);
                map.centerAndZoom(new_point, 15);  // 初始化地图，设置中心点坐标和地图级别
                map.panTo(new_point);

              }, function (error) {
              // 失败了
              });
          }


        }, function (error) {
        });

        document.getElementById('tagok').onclick=function(){
            localtag = document.getElementById('mytag').value;
        };

        document.getElementById('tagsave').onclick=function(){
            var TestObject = AV.Object.extend('MarkObject');
            var testObject = new TestObject();
            testObject.save({
              name: localtag,
              longitude:longitude,
              latitude:latitude
            }).then(function() {
              alert('Marker Saved!');
            }).catch(function(err) {
              alert('error:' + err);
            }); 
        };

            
            
        function showInfo(e){
           
            alert(e.point.lng + ", " + e.point.lat);
            if(e.point.lng!= "" && e.point.lat != ""){
                longitude = e.point.lng;
                latitude  = e.point.lat;
                var new_point = new BMap.Point(e.point.lng,e.point.lat);
                var marker = new BMap.Marker(new_point);  // 创建标注
                map.addOverlay(marker);              // 将标注添加到地图中
                map.panTo(new_point);
                var label = new BMap.Label(localtag,{offset:new BMap.Size(20,-10)});
                marker.setLabel(label);
            }

        }
        map.addEventListener("click", showInfo);
            
            //坐标转换完之后的回调函数
            
                   
            </script>  
        
    </body>  
</html>